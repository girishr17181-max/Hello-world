trigger:
- main

pool:
  name: default

# --- Stage 1: Checkout ---
stages:
- stage: Checkout
  displayName: 'Checkout Code'
  jobs:
  - job: CheckoutCode
    displayName: 'Get code from GitHub'
    steps:
    - checkout: self
      displayName: 'Checkout Source Code'


# --- Stage 2: Maven Build ---
- stage: Build
  displayName: 'Maven Build Stage'
  dependsOn: Checkout
  jobs:
  - job: MavenBuild
    steps:
    - checkout: self
    - task: Maven@4
      displayName: 'Run Maven Build'
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'clean package'

    # Publish the JAR file as an artifact
    - publish: $(System.DefaultWorkingDirectory)/target
      artifact: drop
     
# --- Stage 3: SonarQube ---
- stage: SonarQube
  displayName: 'SonarQube Code Analysis'
  dependsOn: Build
  jobs:
  - job: CodeQuality
    displayName: 'Run SonarQube Analysis'
    steps:
    # Step 1: Prepare SonarQube Scanner
    - task: SonarQubePrepare@5
      displayName: 'Prepare SonarQube Analysis'
      inputs:
        SonarQube: 'sonarQube'  # <-- must match your service connection name
        scannerMode: 'Other'
        extraProperties: |
          sonar.projectKey=java-hello-world
          sonar.projectName=Java Hello World
          sonar.sourceEncoding=UTF-8
          sonar.sources=src/main/java
          

    # Step 2: Run Maven build with SonarQube scan
    - task: Maven@4
      displayName: 'Run SonarQube Maven Build'
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'clean verify sonar:sonar'
        options: >
          -Dsonar.projectKey=java-hello-world
          -Dsonar.projectName=JavaHelloWorld
          -Dsonar.branch.name=""
        publishJUnitResults: false

    # Step 3: Publish SonarQube results
    - task: SonarQubePublish@5
      displayName: 'Publish SonarQube Results'
      inputs:
        pollingTimeoutSec: '300'

# --- Stage 4: Docker Build ---
- stage: DockerBuild
  displayName: 'Docker Build Stage'
  dependsOn: Build
  jobs:
  - job: BuildDockerImage
    steps:
    - checkout: self

    - download: current
      artifact: drop

    - script: |
        echo "Copying JAR from artifact to working directory..."
        cp $(Pipeline.Workspace)/drop/*.jar .
        ls -l
      displayName: "Prepare JAR for Docker build"
    

    - task: Docker@2
      displayName: 'Login to Docker Hub'
      inputs:
        command: login
        containerRegistry: 'docker-hub'
    - task: Docker@2
      displayName: 'Build Docker Image with tag'
      inputs:
        command: build
        repository: 'girishr17181/hello-world'
        Dockerfile: 'Dockerfile'
        buildContext: '.'
        tags: |
          v1.0
          latest

    - script: |
        echo "Verifying images built..."
        docker images
      displayName: "List Docker Images"

    - task: Docker@2
      displayName: 'Push Docker Image to Docker Hub'
      inputs:
        command: push
        containerRegistry: 'docker-hub'
        repository: 'girishr17181/hello-world'
        tags: |
          v1.0
          latest

# --- Stage 5: Deploy to EC2 ---
# --- Stage 5: Deploy to EC2 ---
- stage: DeployToEC2
  displayName: 'Deploy Docker Container to AWS EC2'
  dependsOn: DockerBuild
  jobs:
  - job: Deploy
    displayName: 'Deploy Docker Container on EC2'
    steps:
    - task: SSH@0
      displayName: 'Deploy Docker Container'
      inputs:
        sshEndpoint: 'ec2-ssh'    # âœ… your EC2 service connection name in Azure DevOps
        runOptions: 'commands'
        commands: |
          echo "ðŸš€ Starting Docker deployment on EC2..."

          echo "ðŸ”¹ Logging into Docker Hub..."
          echo "$(dockerHubPassword)" | sudo docker login -u girishr17181 --password-stdin

          echo "ðŸ”¹ Pulling latest image..."
          sudo docker pull girishr17181/hello-world:latest

          echo "ðŸ”¹ Removing any old container..."
          sudo docker rm -f hello-world-app || true

          echo "ðŸ”¹ Starting new container..."
          sudo docker run -d -p 8080:8080 --name hello-world-app girishr17181/hello-world:latest

          echo "âœ… Deployment successful! Running containers:"
          sudo docker ps
